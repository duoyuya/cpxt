# 车辆通知系统

## 项目介绍

车辆通知系统是一个基于Node.js的后台服务，支持车牌管理和多渠道通知发送功能。系统提供直观的Web后台管理界面，可通过Docker快速部署，并支持自定义车牌前缀配置。本优化文档在原始文档基础上，补充了界面操作指南、通知渠道配置细节及移动端使用说明，帮助用户更全面地了解系统功能。

## 功能亮点

### 核心功能
- **车牌信息全生命周期管理**：支持添加、编辑、查询、删除车牌记录
- **多渠道通知推送**：集成WxPusher、企业微信、钉钉、Bark等通知渠道
- **Web后台管理**：直观的配置界面，支持移动端访问
- **数据持久化**：采用SQLite数据库存储配置和通知记录
- **操作日志**：自动记录系统关键操作，便于问题排查

### 界面预览
系统提供响应式设计，支持在手机和电脑上操作，主要界面包括：
- **系统设置页**：配置通知渠道、API令牌等核心参数
- **消息详情页**：查看通知历史和内容格式
- **通知列表页**：集中展示所有挪车通知记录

## 环境要求与部署

### 环境要求
- Docker Engine
- Docker Compose (v3.8+)
- 网络连接（用于拉取镜像和发送通知）
- 浏览器：Chrome 80+、Firefox 75+、Safari 13+或其他现代浏览器

### 快速部署步骤

#### 1. 准备环境配置文件
在项目根目录创建`.env`文件，内容如下：

```env
# 服务器配置
PORT=3000

# 管理员账户配置
ADMIN_USER=admin
ADMIN_PASSWORD_HASH=$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi  # 默认密码: password

# JWT配置
JWT_SECRET=your_jwt_secret_key_here  # 建议修改为随机字符串
JWT_EXPIRES_IN=24h
```

#### 2. 修改管理员密码

**方式一：通过.env文件修改**
1. 访问 [bcrypt-generator.com](https://bcrypt-generator.com/)
2. 输入新密码（如`123456`）
3. 工作因子保持默认`10`
4. 生成哈希值并替换`.env`文件中`ADMIN_PASSWORD_HASH`的值

#### 3. 创建Docker Compose配置

```yaml
version: '3.8'
services:
  car-system:
    image: bmcgal/cpxt:latest  # 也可以替换为ghcr.io/duoyuya/cpxt:latest
    container_name: car-system
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data  # 数据持久化
      - ./.env:/app/.env   # 环境变量配置
    environment:
      - TZ=Asia/Shanghai   # 时区设置
    dns:
      # 补充DNS配置，避免域名解析失败导致网络不通
      - 8.8.8.8
      - 114.114.114.114
```

#### 4. 启动服务

```bash
docker-compose up -d
```

## 系统配置指南

### 访问地址
- **系统主页**: <http://localhost:3000>
- **后台登录**: <http://localhost:3000/admin/login.html>
  + 默认账号: admin
  + 默认密码: password（如未修改）

### 关键配置项说明

#### 通知渠道配置
系统支持四种通知渠道，可在"系统设置"页面配置：

| 渠道名称 | 配置项 | 示例值 | 状态 |
|---------|-------|-------|------|
| WxPusher | APP Token | `AT_Is9Hgc1mpp9bqOgeuQi` | ✅ 默认启用 |
| 企业微信 | 机器人Webhook | `https://qyapi.weixin.qq.com` | ❌ 默认禁用 |
| 钉钉 | 机器人Webhook | `https://oapi.dingtalk.com/robot/send` | ❌ 默认禁用 |
| Bark | 服务器地址 | `https://api.day.app` | ❌ 默认禁用 |

**配置步骤**：
1. 登录后台管理系统
2. 进入"系统设置"页面（顶部标题栏显示"车牌管理系统 - 后台管理"）
3. 找到对应渠道的输入框，填写配置信息
4. 在"默认通知渠道"区域勾选需要启用的渠道
5. 保存配置（具体按钮位置需根据界面查找）

#### 多渠道通知设置
系统支持同时启用多个通知渠道，通知会同时发送到所有勾选的渠道。优先级顺序为：
1. WxPusher
2. 企业微信
3. 钉钉
4. Bark

### 通知功能详解

#### 通知格式示例
系统发送的挪车通知格式统一为：
```
【挪车通知】车牌 云A12345（备注：测试）需要挪车，联系电话：12345678912。请及时处理！
```

字段说明：
- **车牌**：车辆牌照号码，如"云A12345"
- **备注**：可选信息，如"测试"或空
- **联系电话**：车主联系电话，点击可直接拨打（移动端支持）

#### 通知记录查看
所有发送的通知会保存在系统中，可通过以下方式查看：
1. 登录系统后，在首页查看最近通知
2. 进入"订单通知"页面，查看完整通知历史（按时间倒序排列）
3. 点击单个通知，进入详情页查看完整信息

## 移动端使用说明

系统针对手机端做了专门优化，主要操作界面包括：

### 系统设置页面
- **顶部信息**：显示当前时间、网络状态和电量
- **主要配置区**：垂直排列各配置项，每个配置项包含标签和输入框
- **底部导航**：提供返回、前进、首页等快捷操作按钮

### 消息查看页面
- **信息栏**：显示通知来源和发送时间
- **内容区**：展示格式化的通知文本
- **操作按钮**：可能包含回复、转发等功能（根据实际界面调整）

## 常见问题

### Q: 启动后无法访问服务？
A: 检查以下几点：
1. 端口是否被占用：`netstat -tuln | grep 3000`
2. Docker服务状态：`systemctl status docker`
3. 容器运行日志：`docker-compose logs -f`

### Q: 通知发送失败？
A: 排查步骤：
1. 检查DNS配置是否生效：`docker exec -it car-system ping wxpusher.zjiecode.com`
2. 确认通知渠道配置正确，特别是Webhook地址和Token
3. 检查网络连接是否正常，防火墙是否阻止出站连接

### Q: 如何切换通知渠道？
A: 在"系统设置"页面的"默认通知渠道"区域，勾选需要启用的渠道，取消不需要的渠道，保存即可生效。

## 高级配置

### Bark服务器配置
Bark是一款iOS通知工具，配置步骤：
1. 在Bark官网注册账号并获取服务器地址
2. 在系统设置页面的"Bark服务器地址"输入框填写完整URL
3. 勾选"Bark"通知渠道
4. 保存配置后测试通知

### API接口说明
系统提供内部API接口，用于扩展功能：
- **获取通知列表**：`GET /api/notifications`
- **发送测试通知**：`POST /api/test-notification`
- **获取系统配置**：`GET /api/config`

详细接口文档可通过访问`/api-docs`路径查看（如http://localhost:3000/api-docs）。

## 更新日志
- 暂无
